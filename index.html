<!-- index.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>اپ Chand روی وب - مدرن</title>
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      /* Dark Theme Palette */
      --primary-bg: #121212; /* Very dark grey (almost black) */
      --secondary-bg: #1e1e1e; /* Dark grey */
      --text-color: #e0e0e0; /* Light grey for text */
      --text-color-secondary: #b3b3b3; /* Slightly dimmer text */
      --header-bg: linear-gradient(90deg, #0f2027, #203a43, #2c5364); /* Dark blue/grey gradient */
      --header-text: #ffffff;
      --button-bg: linear-gradient(90deg, #0052D4, #4364F7, #6FB1FC); /* Vibrant blue gradient */
      --button-text: #ffffff;
      --button-refresh-bg: linear-gradient(135deg, #2ddc7a, #009e4b); /* New vibrant green gradient */
      --button-refresh-hover-bg: linear-gradient(135deg, #34f08a, #00b356); /* Lighter green on hover */
      --button-refresh-shadow: 0 5px 15px rgba(0, 158, 75, 0.4);
      --card-bg: #2a2a2a; /* Slightly lighter dark grey for cards */
      --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* More pronounced shadow for dark */
      --border-color: #333333; /* Darker border */
      --link-color: #6FB1FC; /* Brighter link color */
      --loading-color: #4364F7; /* Blue loading indicator */
      --error-color: #ff6b6b; /* Softer red for errors */
      --success-color: #4CAF50; /* Green for success */
      --font-family: 'Vazirmatn', sans-serif;
    }

    /* Simple CSS Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth; /* Smooth scrolling */
    }

    body {
      font-family: var(--font-family);
      background-color: var(--primary-bg);
      color: var(--text-color);
      line-height: 1.7; /* Slightly increased line height */
      display: flex;
      justify-content: center;
      padding-top: 90px; /* Slightly increased padding for larger default header */
      padding-bottom: 100px; /* Consistent bottom padding for refresh button */
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #root {
      width: 95%; /* Use percentage for better fluidity */
      max-width: 900px; /* Increased max-width for web */
      padding: 30px; /* Increased padding */
      background-color: var(--secondary-bg);
      border-radius: 15px; /* Slightly more rounded */
      box-shadow: var(--card-shadow);
      margin: 20px auto; /* Center horizontally */
      border: 1px solid var(--border-color);
      /* Removed fixed padding-bottom, handle spacing differently */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added transition */
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 20px 25px; /* Increased header padding */
      text-align: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Stronger shadow */
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      animation: slideDown 0.6s ease-out forwards; /* Header slide down animation */
      display: flex; /* Use flexbox for alignment */
      align-items: center;
      justify-content: space-between; /* Space out elements */
    }

    header h1 {
      flex-grow: 1; /* Allow title to take up space */
      text-align: center; /* Center title text */
      margin: 0; /* Reset margin if needed */
      font-size: 2.1em; /* Slightly larger base size */
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    header h1 i {
      margin: 0 10px; /* Space around header icon */
      font-size: 0.9em;
      opacity: 0.8;
    }

    #update {
      font-size: 0.95em; /* Slightly larger */
      margin-top: 8px;
      color: var(--text-color-secondary);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Increased min button width */
      gap: 18px; /* Increased gap */
      margin-bottom: 30px; /* Increased margin */
    }

    .btn {
      padding: 15px 22px; /* Slightly larger padding */
      border: none;
      border-radius: 30px;
      font-size: 1.1em; /* Slightly larger base font */
      font-weight: bold;
      cursor: pointer;
      background: var(--button-bg);
      color: var(--button-text);
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      background-size: 200% auto; /* For gradient animation */
      display: flex; /* Use flex for icon alignment */
      align-items: center;
      justify-content: center;
      gap: 10px; /* Space between icon and text */
    }
     .btn i {
         font-size: 1.1em; /* Adjust icon size within button */
         line-height: 1; /* Ensure proper vertical alignment */
     }

    .btn:hover {
      background-position: right center;
      filter: brightness(1.15);
      transform: translateY(-4px) scale(1.02); /* Slightly more lift and scale */
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.25);
    }

    .btn:active {
      transform: translateY(-1px) scale(0.98); /* Slightly shrink on active */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #output {
      margin-top: 30px; /* Increased margin */
      min-height: 180px; /* Increased min height */
      border: 1px solid var(--border-color);
      border-radius: 12px; /* Match root rounding */
      padding: 25px; /* Increased padding */
      background-color: var(--card-bg); /* Card background for output */
      transition: background-color 0.3s ease;
      overflow: hidden; /* Needed for list item animation */
    }

    #output ul {
      list-style-type: none;
      padding: 0;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #output li {
      background: var(--secondary-bg); /* Darker background for list items */
      margin-bottom: 14px; /* Increased spacing */
      padding: 16px 20px; /* Adjusted padding */
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      border-right: 5px solid var(--loading-color);
      transition: transform 0.25s ease, background-color 0.25s ease, border-color 0.25s ease;
      color: var(--text-color);
      font-size: 1.1em; /* Slightly larger base font */
      cursor: pointer; /* Indicate clickable */
      opacity: 0; /* Start hidden for animation */
      animation: fadeInUp 0.5s ease forwards;
    }
    /* Stagger animation delay */
    #output li:nth-child(1) { animation-delay: 0.05s; }
    #output li:nth-child(2) { animation-delay: 0.1s; }
    #output li:nth-child(3) { animation-delay: 0.15s; }
    #output li:nth-child(4) { animation-delay: 0.2s; }
    #output li:nth-child(5) { animation-delay: 0.25s; }
    #output li:nth-child(6) { animation-delay: 0.3s; }
    #output li:nth-child(7) { animation-delay: 0.35s; }
    #output li:nth-child(8) { animation-delay: 0.4s; }
    #output li:nth-child(9) { animation-delay: 0.45s; }
    #output li:nth-child(10) { animation-delay: 0.5s; }
    /* Add more if needed */

    #output li:hover {
      transform: translateX(-6px) scale(1.01); /* Slight scale on hover */
      background-color: #333;
      border-right-color: var(--link-color);
    }

    #output li.error {
      color: var(--error-color);
      border-right-color: var(--error-color);
      font-weight: bold;
      cursor: default; /* Not clickable if error */
    }
    #output li.error span.error { /* Style the specific error span if needed */
      color: var(--error-color);
    }
    #output li.error:hover {
      transform: none; /* Disable hover effect for error items */
      background-color: var(--secondary-bg);
    }

    /* Styles for Conversion Modal (using SweetAlert now mostly) */
    /* Keep basic modal styles for potential future non-SweetAlert use */
    .modal { display: none; /* Hidden by default, SweetAlert handles visibility */ }
    .modal-content { background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); }
    .close-btn { color: #aaa; }
    .close-btn:hover, .close-btn:focus { color: var(--text-color); }
    .modal-content label { color: var(--text-color); }
    .modal-content input[type="number"], .modal-content select {
      background-color: var(--primary-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    .modal-content input::placeholder { color: var(--text-color-secondary); }
    .modal-content select option { background-color: var(--primary-bg); color: var(--text-color); }


    #conversionResult {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
      padding: 12px;
      background-color: var(--card-bg);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      color: var(--success-color);
    }
    #conversionResult.error {
       color: var(--error-color);
     }

    /* Loading Spinner */
    .loader {
      border: 6px solid #444; /* Darker base */
      border-top: 6px solid var(--loading-color); /* Brighter top */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 25px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* New styles for the fixed refresh button container */
    #refresh-container {
      position: fixed;
      bottom: 30px; /* Increased distance from bottom */
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
    }

    @keyframes spinRefresh {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    #btnRefresh {
      width: 65px; /* Slightly larger */
      height: 65px;
      border-radius: 50%; /* Make it circular */
      padding: 0; /* Remove padding */
      display: flex; /* Center the icon */
      align-items: center;
      justify-content: center;
      font-size: 1.6em; /* Adjusted for Font Awesome icon */
      background: var(--button-refresh-bg);
      color: var(--button-text);
      box-shadow: var(--button-refresh-shadow);
      cursor: pointer;
      border: none;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
      outline: none;
    }
    /* Class added during refresh */
    #btnRefresh.loading i {
      animation: spinRefresh 1s linear infinite;
    }
    #btnRefresh.loading {
      cursor: not-allowed;
      filter: brightness(0.8);
    }

    #btnRefresh:hover {
      background: var(--button-refresh-hover-bg);
      transform: scale(1.1) translateY(-3px); /* Scale up and lift */
      box-shadow: 0 8px 20px rgba(0, 158, 75, 0.5); /* Stronger shadow on hover */
      filter: brightness(1.1);
    }
    /* Prevent hover effect when loading */
    #btnRefresh.loading:hover {
       background: var(--button-refresh-bg); /* Revert background */
       transform: scale(1) translateY(0); /* Revert transform */
       box-shadow: var(--button-refresh-shadow); /* Revert shadow */
       filter: brightness(0.8);
     }

     #btnRefresh:active {
       transform: scale(1.05) translateY(-1px); /* Slightly smaller press effect */
       box-shadow: 0 4px 10px rgba(0, 158, 75, 0.4);
     }

    /* Responsive Design */
    @media (min-width: 1200px) {
      #root {
        max-width: 1100px; /* Even wider on very large screens */
      }
      header h1 {
        font-size: 2.3em;
      }
      .btn {
        font-size: 1.15em;
      }
      #output li {
        font-size: 1.15em;
      }
    }
    @media (max-width: 900px) {
       body { padding-top: 80px; padding-bottom: 90px;}
       #root {
           width: 90%; /* Adjust width */
           padding: 25px;
           max-width: 700px; /* Limit width on medium screens */
       }
       header h1 { font-size: 1.9em; }
       #update { font-size: 0.9em; }
       .controls { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
       .btn { font-size: 1.05em; padding: 14px 20px; }
       #output li { font-size: 1.05em; padding: 15px 18px; }
       #btnRefresh { width: 60px; height: 60px; font-size: 1.8em; }
       #refresh-container { bottom: 25px; }
   }
    @media (max-width: 600px) {
       body { padding-top: 70px; padding-bottom: 80px; }
       #root {
           width: 95%; /* Near full width on mobile */
           padding: 20px;
           border-radius: 12px;
           margin: 10px auto;
       }
       header h1 { font-size: 1.7em; }
       #update { font-size: 0.85em; }
       .controls { grid-template-columns: 1fr 1fr; gap: 12px; }
       .btn { font-size: 1em; padding: 12px 15px; }
       #output li { font-size: 1em; padding: 12px 15px; }
       #btnRefresh { width: 55px; height: 55px; font-size: 1.6em; }
       #refresh-container { bottom: 20px; }
   }
    @media (max-width: 400px) {
       body { padding-top: 65px; padding-bottom: 75px; }
       header h1 { font-size: 1.5em; }
       #update { font-size: 0.8em; }
       .btn { font-size: 0.95em; padding: 11px 13px; }
        #output li { font-size: 0.95em; padding: 11px 13px; }
       #btnRefresh { width: 50px; height: 50px; font-size: 1.5em; }
       #refresh-container { bottom: 15px; }
   }

     /* SweetAlert Dark Theme Adjustments */
     body.swal2-shown > [aria-hidden="true"] {
       filter: blur(3px); /* Blur background when modal is open */
     }
     .swal2-popup {
       background: var(--secondary-bg) !important;
       color: var(--text-color) !important;
       border-radius: 10px !important;
       border: 1px solid var(--border-color);
       box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
     }
     .swal2-title {
       color: var(--text-color) !important;
     }
     .swal2-html-container {
        color: var(--text-color-secondary) !important;
     }
     .swal2-input, .swal2-select {
       background: var(--primary-bg) !important;
       color: var(--text-color) !important;
       border: 1px solid var(--border-color) !important;
     }
      .swal2-input::placeholder { color: var(--text-color-secondary) !important; }
     .swal2-confirm {
       background: var(--button-bg) !important;
       background-image: var(--button-bg) !important; /* Ensure gradient applies */
       color: var(--button-text) !important;
       border-radius: 20px !important;
       padding: 10px 25px !important;
        transition: filter 0.2s ease !important;
        border: none !important;
     }
     .swal2-confirm:hover {
        filter: brightness(1.15) !important;
     }
     .swal2-cancel {
       background-color: #555 !important;
       color: var(--button-text) !important;
        border-radius: 20px !important;
        padding: 10px 25px !important;
        transition: background-color 0.3s ease !important;
        border: none !important;
     }
      .swal2-cancel:hover {
         background-color: #666 !important;
       }
      .swal2-loader {
         border-color: var(--loading-color) transparent var(--loading-color) transparent !important;
      }
      .swal2-success-ring {
        border-color: rgba(76, 175, 80, 0.7) !important; /* Slightly adjust success indicator */
      }

     /* Add Vazirmatn font */
     @font-face {
       font-family: 'Vazirmatn';
       src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
       font-weight: normal;
       font-style: normal;
       font-display: swap;
     }
     @font-face {
       font-family: 'Vazirmatn';
       src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
       font-weight: bold;
       font-style: normal;
       font-display: swap;
    }

    /* Settings Button Style */
    #settingsButton {
      background: none;
      border: none;
      color: var(--header-text);
      font-size: 1.8em; /* Adjust size */
      cursor: pointer;
      padding: 0 15px; /* Add some padding */
      transition: transform 0.2s ease, color 0.2s ease;
    }
    #settingsButton:hover {
      transform: scale(1.1) rotate(15deg);
      color: var(--link-color);
    }

    /* --- Settings Modal Styles --- */
    .modal-overlay {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
      z-index: 1050;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }
    .modal-overlay.active {
      display: flex; /* Show using flex */
    }

    @keyframes fadeInModal {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .settings-modal {
      background-color: var(--secondary-bg);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 500px;
      position: relative;
      color: var(--text-color);
      animation: fadeInModal 0.3s ease-out forwards;
      padding-bottom: 20px; /* Ensure space at bottom */
    }

    .settings-modal h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      color: var(--link-color);
    }

    .settings-modal label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .settings-modal input[type="url"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px; /* Increased margin */
      border: 1px solid var(--border-color);
      background-color: var(--primary-bg);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 1em;
      font-family: var(--font-family);
      direction: ltr; /* Ensure URL input is LTR */
      text-align: left;
    }
    .settings-modal input[type="url"]::placeholder {
      color: var(--text-color-secondary);
      text-align: left;
    }

    .settings-modal .modal-actions {
      display: flex;
      justify-content: space-between; /* Space out buttons */
      gap: 15px;
      margin-top: 20px;
    }

    .settings-modal .modal-actions button {
      flex-grow: 1; /* Make buttons share space */
      padding: 12px 20px;
      font-size: 1em;
    }

    .settings-modal .modal-close-btn {
      position: absolute;
      top: 15px;
      left: 15px; /* Positioned to the left for RTL */
      background: none;
      border: none;
      font-size: 1.8em;
      color: var(--text-color-secondary);
      cursor: pointer;
      padding: 5px;
      line-height: 1;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .settings-modal .modal-close-btn:hover {
       color: var(--error-color);
       transform: scale(1.1);
     }
     .settings-modal p.note {
       font-size: 0.9em;
       color: var(--text-color-secondary);
       margin-top: 15px;
       text-align: center;
     }

    /* New styles for the toggle switch */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
     .setting-row:last-of-type {
       border-bottom: none;
       margin-bottom: 15px;
     }

    .setting-row label {
      margin-bottom: 0; /* Remove bottom margin for label in row */
      flex-grow: 1; /* Allow label to take space */
      padding-left: 10px; /* Space between label and switch */
    }

    /* Basic Toggle Switch Styles */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px; /* Width of the switch */
      height: 26px; /* Height of the switch */
    }

    .switch input { display: none; }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555; /* Off state background */
      transition: .4s;
      border-radius: 26px; /* Rounded slider */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px; /* Height of the knob */
      width: 20px; /* Width of the knob */
      left: 3px; /* Position from left */
      bottom: 3px; /* Position from bottom */
      background-color: white;
      transition: .4s;
      border-radius: 50%; /* Circular knob */
    }

    input:checked + .slider {
      background-color: var(--success-color); /* On state background */
    }

    input:checked + .slider:before {
      transform: translateX(24px); /* Move knob to the right */
    }
  </style>
</head>
<body>
  <header>
    <!-- Settings Button Added -->
    <button id="settingsButton" title="تنظیمات"><i class="fa-solid fa-gear"></i></button>

    <h1><i class="fa-solid fa-dollar-sign"></i> Chand <i class="fa-solid fa-dollar-sign"></i></h1>

    <!-- Placeholder for potential future elements on the right -->
    <div style="width: 40px;"></div> <!-- Adjust width to match settings button approx size -->
  </header>

  <div id="root">
    <div class="controls">
      <button class="btn" id="btnCurrency">ارزها 💵</button>
      <button class="btn" id="btnGold">قیمت طلا 🪙</button>
      <button class="btn" id="btnCoin">قیمت سکه 💰</button>
      <button class="btn" id="btnConvert">تبدیل ارز 💱</button>
    </div>
    <div id="output">
      <p style="text-align: center; color: var(--text-color-secondary);">برای مشاهده قیمت‌ها، یکی از دکمه‌های بالا را انتخاب کنید.</p>
    </div>
  </div>

  <!-- Refresh Button Container Added at the end -->
  <div id="refresh-container">
    <button class="btn" id="btnRefresh" title="رفرش و پاک کردن کش">🔄</button>
  </div>

  <!-- Settings Modal Modified -->
  <div id="settingsModalOverlay" class="modal-overlay">
    <div class="settings-modal">
      <button class="modal-close-btn" id="closeSettingsModal" title="بستن">&times;</button>
      <h2><i class="fa-solid fa-sliders"></i> تنظیمات</h2>

      <div class="setting-row">
        <label for="useProxyToggle">استفاده از پروکسی در صورت نیاز:</label>
        <label class="switch">
          <input type="checkbox" id="useProxyToggle">
          <span class="slider"></span>
        </label>
      </div>

      <label for="customProxyInput">آدرس پروکسی CORS سفارشی (اختیاری):</label>
      <input type="url" id="customProxyInput" placeholder="مثال: https://my-proxy.example.com/">
      <p class="note">اگر فعال باشد و این فیلد خالی باشد، از پروکسی پیش‌فرض استفاده می‌شود.</p>

      <div class="modal-actions">
        <button class="btn" id="saveSettingsButton"><i class="fa-solid fa-save"></i> ذخیره تنظیمات</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
const chandeUrl = 'https://chande.net';
    const tgjuBaseUrl = 'https://www.tgju.org/profile/';
    const DEFAULT_PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
    const CUSTOM_PROXY_STORAGE_KEY = 'customProxyUrl';
    const USE_PROXY_FALLBACK_KEY = 'useProxyFallback';
    const DIRECT_FETCH_TIMEOUT_MS = 4500;

const currencies = [
      { code: 'usd', title: 'دلار آمریکا', unit: 'تومان', chandeCode: 'USD', tgjuProfile: 'price_dollar_rl' },
      { code: 'eur', title: 'یورو', unit: 'تومان', chandeCode: 'EUR' , tgjuProfile: 'price_eur'},
      { code: 'gbp', title: 'پوند انگلیس', unit: 'تومان', chandeCode: 'GBP', tgjuProfile: 'price_gbp' },
      { code: 'aed', title: 'درهم امارات', unit: 'تومان', chandeCode: 'AED', tgjuProfile: 'price_aed' }
];

const additionalAssets = [
      { title: 'طلا 18 عیار', profile: 'geram18', unit: 'تومان', category: 'gold', needsTomanConversion: true },
      { title: 'انس جهانی طلا', profile: 'ons', unit: 'دلار', category: 'gold', needsTomanConversion: false },
      { title: 'مثقال طلا', profile: 'mesghal', unit: 'تومان', category: 'gold', needsTomanConversion: true },
      { title: 'طلای ۲۴ عیار', profile: 'geram24', unit: 'تومان', category: 'gold', needsTomanConversion: true },
      { title: 'سکه امامی', profile: 'sekee', unit: 'تومان', category: 'coin', needsTomanConversion: true },
      { title: 'نیم سکه', profile: 'nim', unit: 'تومان', category: 'coin', needsTomanConversion: true },
      { title: 'ربع سکه', profile: 'rob', unit: 'تومان', category: 'coin', needsTomanConversion: true },
      { title: 'سکه گرمی', profile: 'gerami', unit: 'تومان', category: 'coin', needsTomanConversion: true }
    ];

    const outputDiv = document.getElementById('output');
    const updateEl = document.getElementById('update');
    const refreshButton = document.getElementById('btnRefresh');
    const settingsButton = document.getElementById('settingsButton');
    const settingsModalOverlay = document.getElementById('settingsModalOverlay');
    const closeSettingsModalButton = document.getElementById('closeSettingsModal');
    const customProxyInput = document.getElementById('customProxyInput');
    const useProxyToggle = document.getElementById('useProxyToggle');
    const saveSettingsButton = document.getElementById('saveSettingsButton');

    let conversionRatesPromise = null;
    let lastFetchedCategory = null;
    let currentProxyUrl = DEFAULT_PROXY_URL;
    let useProxyFallback = true; // Default to using proxy fallback

    // ==========================================================================
    // DOM Element Caching
    // ==========================================================================
    /** Caches frequently used DOM elements into state.dom */
    function cacheDOMElements() {
        state.dom.outputDiv = document.querySelector(C.OUTPUT_SELECTOR);
        state.dom.updateEl = document.getElementById('update'); // Target line for logging
        // Log whether the element was found
        if (state.dom.updateEl) {
            console.log("[CacheDOM] #update element found successfully.");
        } else {
            console.error("[CacheDOM] #update element NOT FOUND!"); // Log error if not found
        }
        state.dom.refreshButton = document.getElementById('btnRefresh');
        state.dom.settingsButton = document.getElementById('settingsButton');
        /* ... cache other elements ... */
        state.dom.btnConvert = document.getElementById('btnConvert');
    }

    /* ... Helper Functions ... */

    /** Updates the date and time display. */
     function updateDateTime() {
         try {
             const now = new Date();
             const persianDate = now.toLocaleDateString('fa-IR-u-nu-latn', { timeZone: 'Asia/Tehran', year: 'numeric', month: 'long', day: 'numeric' });
             const time = now.toLocaleTimeString('fa-IR-u-nu-latn', { timeZone: 'Asia/Tehran', hour: '2-digit', minute: '2-digit', hour12: false });
             // Check if the element exists before setting textContent
             if (state.dom.updateEl) {
                 state.dom.updateEl.textContent = `آخرین بروزرسانی: ${persianDate} - ${time}`;
             } else {
                  console.warn("[UI] Cannot update time: #update element is null.");
              }
         } catch (e) {
             console.error("[UI] Error updating date/time logic:", e); // Log the error in the logic itself
             // Also check if element exists before setting error text
             if (state.dom.updateEl) {
                 state.dom.updateEl.textContent = "خطا در بروزرسانی زمان";
             } else {
                  console.warn("[UI] Cannot display time update error: #update element is null.");
              }
         }
     }

    // ... (Rest of the script ... */
  </script>
</body>
</html>
